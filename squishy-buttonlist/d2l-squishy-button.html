<!-- TODO: A "resting-color" -->
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-colors/d2l-colors.html">
<link rel="import" href="../../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="./d2l-squishy-buttonlist-behavior.html">

<dom-module id="d2l-squishy-button">
<template strip-whitespace>
		<style>
			:host {
				background: none;
				border: solid 1px var(--d2l-color-mica);
				border-right: none;
				color: var(--d2l-color-galena);
				display: flex;
				flex: 1;
				height: 30px;
				outline: none;
				overflow: hidden;
				text-align: center;
				position: relative;
				z-index: 0;
			}

			:host([selected]) {
				border: solid 1px var(--d2l-squishy-button-selected-color, var(--d2l-color-galena));
			}

			:host([selected])::before,
			:host([focused]:not([read-only]))::before,
			:host(:hover:not([read-only]))::before {
				background-color: var(--d2l-squishy-button-selected-color, var(--d2l-color-galena));
				opacity: 0.1;
				content: "";
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				z-index: -1;
			}

			:host([focused]) {
				border: solid 1px var(--d2l-squishy-button-selected-color, rgba(0, 111, 191, 0.4));
				box-shadow: 0 0 0 4px rgb(178, 211, 235);
				z-index: 2;
			}

			.d2l-squishy-button-inner,
			.d2l-squishy-button-inner:focus,
			.d2l-squishy-button-inner:hover {
				background: none;
				border: none;
				outline: none;
				width: 100%;
				z-index: 1;
				cursor: pointer;
			}

			:host([read-only]) {
				pointer-events: none;
				cursor: default;
			}

			[hidden] {
				display: none !important;
			}

			/* Default inside styling */
			::slotted(*) {
				@apply --d2l-body-small-text;
				margin: 5px auto 5px auto;
				padding-left: 5px;
				padding-right: 5px;
				word-break: break-all;
				overflow: hidden;
				pointer-events: none;
			}

			:host([selected]) ::slotted(*) {
				font-weight: 700;
				color: var(--d2l-color-ferrite);
			}
		</style>

		<button class="d2l-squishy-button-inner" on-keydown="_onKeyDown" aria-label="{{ariaLabel}}">
			<slot></slot>
		</button>
	</template>
	<script>
		Polymer({
			is: 'd2l-squishy-button',

			properties: {
				selected: {
					type: Boolean,
					reflectToAttribute: true
				},

				ariaLabel: {
					type: String
				},

				focused: {
					type: Boolean,
					value: false,
					reflectToAttribute: true
				},

				index: {
					type: Number,
					reflectToAttribute: true
				},

				buttonData: {
					type: Object,
					value: function() { return {}; }
				},

				readOnly: {
					type: Boolean,
					value: false,
					reflectToAttribute: true,
					observer: '_readOnlyChanged'
				}
			},

			listeners: {
				'keydown': '_onKeyDown',
				'tap': '_handleTap'
			},

			behaviors: [
				D2L.PolymerBehaviors.OutcomesLOA.SquishyButtonListBehavior
			],

			attached: function() {
				Polymer.RenderStatus.afterNextRender(this, function () {
					this.addEventListener('focus', this._onFocus, true);
					this.addEventListener('blur', this._onBlur, true);
				}.bind(this));
			},

			detached: function() {
				this.removeEventListener('focus', this._onFocus);
				this.removeEventListener('blur', this._onBlur);
			},

			ready: function() {
				this._readOnlyChanged(this.readOnly);
			},

			_onKeyDown: function (event) {
				if (this.readOnly) {
					return;
				}

				if (event.keyCode === this._keyCodes.ENTER) {
					this.itemSelected(event.currentTarget.dataset);
				}
			},

			_handleTap: function (event) {
				if (this.readOnly) {
					return;
				}

				this.itemSelected(event.currentTarget.dataset);
				this.focus();
			},

			itemSelected: function (event) {
				this.dispatchEvent(new CustomEvent('item-selected', {
					detail: {
						index: this.index,
						data: this.buttonData
					},
					bubbles: true
				}));
			},

			focus: function() {
				if (this.readOnly) {
					return;
				}
				this.$$('.d2l-squishy-button-inner').focus();
			},

			_onFocus: function () {
				if (this.readOnly) {
					return;
				}
				this.focused = true;
			},

			_onBlur: function () {
				this.focused = false;
			},

			_readOnlyChanged: function(readOnly) {
				var button = this.$$('.d2l-squishy-button-inner');

				if (readOnly && button.getAttribute('tabindex') === "-1") {
					return;
				}

				if (readOnly) {
					this._prevTabIndex = button.hasAttribute('tabindex') ? button.getAttribute('tabindex') : null;
					button.setAttribute('tabindex', '-1');
				} else if (this._prevTabIndex !== null) {
					button.setAttribute('tabindex', this._prevTabIndex);
					this._prevTabIndex = null;
				} else {
					button.removeAttribute('tabindex');
				}
			}

		});
	</script>
</dom-module>
