<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-colors/d2l-colors.html">
<link rel="import" href="../../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="./keycodes-behavior.html">

<dom-module id="d2l-squishy-button">
	<template strip-whitespace>
		<style>
			:host {
				background: var(--d2l-color-white);
				border: solid 1px var(--d2l-color-mica);
				border-right: none;
				color: var(--d2l-color-galena);
				display: flex;
				flex: 1;
				height: 100%;
				outline: none;
				overflow: hidden;
				text-align: center;
			}

			:host(:hover) {
				background-color: var(--d2l-color-gypsum);
				cursor: pointer;
			}

			:host([selected]) {
				background-color: var(--d2l-color-gypsum);
				border: solid 1px var(--d2l-color-galena);
			}

			:host([focused]) {
				background-color: var(--d2l-color-gypsum);
				border: solid 1px rgba(0, 111, 191, 0.4);
				box-shadow: 0 0 0 4px rgb(178, 211, 235);
				z-index: 0;
			}

			.level,
			.level:focus,
			.level:hover {
				background: none;
				border: none;
				outline: none;
				width: 100%;
			}

			[hidden] {
				display: none !important;
			}
		</style>

		<button class="level" on-keydown="_onKeyDown" aria-label="{{ariaLabel}}">
			<slot></slot>
		</button>
	</template>
	<script>
		Polymer({
			is: 'd2l-squishy-button',

			properties: {
				selected: {
					type: Boolean,
					reflectToAttribute: true
				},

				readOnly: {
					type: Boolean,
					value: false
				},

				ariaLabel: {
					type: String
				},

				focused: {
					type: Boolean,
					value: false,
					reflectToAttribute: true
				},

				index: {
					type: Number,
					reflectToAttribute: true
				}
			},

			listeners: {
				'keydown': '_onKeyDown',
				'tap': '_handleTap'
			},

			behaviors: [
				D2L.PolymerBehaviors.OutcomesLOA.KeyCodesBehavior
			],

			attached: function() {
				Polymer.RenderStatus.afterNextRender(this, function () {
					this.addEventListener('focus', this._onFocus, true);
					this.addEventListener('blur', this._onBlur, true);
				}.bind(this));
			},

			detached: function() {
				this.removeEventListener('focus', this._onFocus);
				this.removeEventListener('blur', this._onBlur);
			},

			_onKeyDown: function (event) {
				if (event.keyCode === this._keyCodes.ENTER) {
					this.itemSelected(event.currentTarget.dataset);
				}
			},

			_handleTap: function (event) {
				if (this.readOnly) {
					return;
				}
				this.itemSelected(event.currentTarget.dataset);
			},

			itemSelected: function (event) {
				this.dispatchEvent(new CustomEvent('item-selected', {
					detail: {
						index: this.index
					},
					bubbles: true
				}));
			},

			focus: function() {
				this.$$('.level').focus();
			},

			_onFocus: function () {
				this.focused = true;
			},

			_onBlur: function () {
				this.focused = false;
			}
		});
	</script>
</dom-module>
