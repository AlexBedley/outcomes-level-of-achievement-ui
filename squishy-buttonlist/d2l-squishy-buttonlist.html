<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-colors/d2l-colors.html">
<link rel="import" href="../../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="./d2l-squishy-buttonlist-behavior.html">

<!--
`d2l-squishy-buttonlist`
Polymer Web-Component to display squishy button lists

@demo demo/index.html
-->
<dom-module id="d2l-squishy-buttonlist">
	<template strip-whitespace>
		<style>
			:host {
				display:block;
				height: 32px;
				background: white;
			}
			.d2l-squishy-buttons-container {
				display: inline-flex;
				height: 32px;
				width: 100%;
			}
			.d2l-squishy-buttons {
				display: inline-flex;
				width: calc(100% - 1px);
			}

			::slotted(d2l-squishy-button[selected] + d2l-squishy-button:not([focused])) {
				border-left: none;
			}

			::slotted(d2l-squishy-button:last-of-type) {
				border-top-right-radius: 6px;
				border-bottom-right-radius: 6px;
			}

			::slotted(d2l-squishy-button:last-of-type:not([focused]):not([selected])) {
				border-right: solid 1px var(--d2l-color-mica);
			}

			::slotted(d2l-squishy-button:first-of-type) {
				border-top-left-radius: 6px;
				border-bottom-left-radius: 6px;
			}

			::slotted(d2l-squishy-button:first-of-type:not([focused]):not([selected])) {
				border-left: solid 1px var(--d2l-color-mica);
			}

			[hidden] {
				display: none !important;
			}
		</style>
		<div class="d2l-squishy-buttons-container">
			<div class="d2l-squishy-buttons" role="tablist">
				<slot></slot>
			</div>
		</div>
	</template>
	<script>
		Polymer({
			is: 'd2l-squishy-buttonlist',

			properties: {
				selectedIndex: {
					type: Number,
					notify: true,
					observer: '_updateButtonSelectedAttribute'
				},
				readOnly: {
					type: Boolean,
					value: false,
					reflectToAttribute: true
				}
			},

			behaviors: [
				D2L.PolymerBehaviors.OutcomesLOA.SquishyButtonListBehavior
			],

			listeners: {
				'item-selected': '_onItemSelected',
				'keydown': '_onKeyDown'
			},

			ready: function() {
				Polymer.RenderStatus.afterNextRender(this, function() {
					this._handleDomChanges();
					this._slotObserver = Polymer.dom(this).observeNodes(this._handleDomChanges);
				});
			},

			detached: function() {
				if (this._slotObserver) {
					Polymer.dom(this).unobserveNodes(this._slotObserver);
				}
			},

			_handleDomChanges: function() {
				this._getListOfAllButtons();
				this._setButtonProperties();
			},

			_getListOfAllButtons() {
				var buttonList = [];
				var childrenArray = this.getEffectiveChildren();
				this._buttons = childrenArray.filter(function(tag) {
					return tag.nodeName === this._buttonTagName;
				}.bind(this));
			},

			_setButtonProperties() {
				if (!this._buttons) {
					return;
				}

				for (var i=0; i < this._buttons.length; i++) {
					var button = this._buttons[i];
					button.setAttribute('index', i);
					if (this.readOnly) {
						button.setAttribute('read-only', this.readOnly);
					} else {
						button.removeAttribute('read-only', this.readOnly);
					}
				}
			},

			_updateButtonSelectedAttribute(selectedIndex) {
				if (!this._buttons) {
					return;
				}

				for (var i=0; i < this._buttons.length; i++) {
					var isSelected = i === selectedIndex;
					if (isSelected) {
						this._buttons[i].setAttribute('selected', 'true');
					} else {
						this._buttons[i].removeAttribute('selected');
					}
				}
			},

			_getSquishyButtonFromEventPath: function(eventPath) {
				if (!eventPath) {
					return null;
				}

				for (var i = 0; i<eventPath.length; i++) {
					if (eventPath[i].nodeName === this._buttonTagName) {
						return eventPath[i];
					}
				}

				return null;
			},

			_onKeyDown: function(event) {
				var button = this._getSquishyButtonFromEventPath(event.path);

				if (!button || this.readOnly) {
					return;
				}

				if (event.keyCode == this._keyCodes.LEFT && !!button.previousElementSibling) {
					button.previousElementSibling.focus();
					event.preventDefault();
				} else if (event.keyCode == this._keyCodes.RIGHT && !!button.nextElementSibling) {
					button.nextElementSibling.focus();
					event.preventDefault();
				}
			},

			_onItemSelected: function(event) {
				this.selectedIndex = event.detail.index;
				event.preventDefault();
			}
		});
	</script>
</dom-module>
